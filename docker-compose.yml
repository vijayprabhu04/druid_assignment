version: "2"
services:
  mysql:
    container_name: mysql
    image: mariadb:latest
    environment:
      - MYSQL_ROOT_PASSWORD=keepasecret
      - MYSQL_USER=druid
      - MYSQL_PASSWORD=keepasecret
      - MYSQL_DATABASE=druid
    command:
      - '--character-set-server=utf8'
      - '--collation-server=utf8_unicode_ci'

  zookeeper:
    container_name: zookeeper
    image: zookeeper
    environment:
      - ZOO_MY_ID=1
      - ZOO_SERVERS=zookeeper

  kafka:
    container_name: kafka
    image: confluentinc/cp-kafka
    environment:
        KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://:9092
        KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
        KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    depends_on:
      - zookeeper

  coordinator:
    hostname: coordinator
    container_name: coordinator
    image: assignment/druid
    build: .
    ports:
      - "3001:8081"
    environment:
      - DRUID_XMX=2g
      - DRUID_XMS=2g
      - DRUID_MAXNEWSIZE=250m
      - DRUID_NEWSIZE=250m
      - MYSQL_USERNAME=druid
      - MYSQL_PASSWORD=keepasecret
      - KAFKA_BOOTSTRAP=kafka:9092
    depends_on:
      - mysql
      - zookeeper
      - kafka
    volumes:
      - /Users/prathang/Prathang/Learnings/Assignment/data:/var/data/
      - /Users/prathang/Prathang/Learnings/Assignment/logs:/opt/druid/var/druid/indexing-logs
    command:
      - coordinator

  broker:
    hostname: broker
    container_name: broker
    image: assignment/druid
    build: .
    ports:
      - "3002:8082"
    environment:
      - DRUID_XMX=2g
      - DRUID_XMS=2g
      - DRUID_MAXNEWSIZE=250m
      - DRUID_NEWSIZE=250m
      - DRUID_MAXDIRECTMEMORY=1g
      - DRUID_PROCESS_THREADS=2
      - DRUID_PROCESS_BUFFER=53687091
      - MYSQL_USERNAME=druid
      - MYSQL_PASSWORD=keepasecret
      - KAFKA_BOOTSTRAP=kafka:9092
      - MEMCACHED_HOST=memcached
    depends_on:
      - mysql
      - zookeeper
      - kafka
      - coordinator
    command:
      - broker

  historical:
    hostname: historical
    container_name: historical
    image: assignment/druid
    build: .
    ports:
      - "3003:8083"
    environment:
      - DRUID_XMX=2g
      - DRUID_XMS=2g
      - DRUID_MAXNEWSIZE=250m
      - DRUID_NEWSIZE=250m
      - MYSQL_USERNAME=druid
      - MYSQL_PASSWORD=keepasecret
      - KAFKA_BOOTSTRAP=kafka:9092
      - DRUID_MAXDIRECTMEMORY=1g
      - DRUID_PROCESS_THREADS=2
      - DRUID_PROCESS_BUFFER=53687091
    depends_on:
      - mysql
      - zookeeper
      - kafka
      - coordinator
    volumes:
      - /Users/prathang/Prathang/Learnings/Assignment/deep_storage:/opt/druid/var/druid/segments
    command:
      - historical

  middlemanager:
    hostname: middlemanager
    container_name: middlemanager
    image: assignment/druid
    build: .
    ports:
      - "4001:8091"
    cpu_shares: 7000
    environment:
      - DRUID_XMX=2g
      - DRUID_XMS=2g
      - DRUID_MAXNEWSIZE=250m
      - DRUID_NEWSIZE=250m
      - DRUID_MAXDIRECTMEMORY=1g
      - DRUID_PROCESS_THREADS=2
      - DRUID_PROCESS_BUFFER=53687091
      - MYSQL_USERNAME=druid
      - MYSQL_PASSWORD=keepasecret
      - KAFKA_BOOTSTRAP=kafka:9092
    depends_on:
      - mysql
      - zookeeper
      - kafka
      - coordinator
    volumes:
      - /Users/prathang/Prathang/Learnings/Assignment/data:/var/data/
      - /Users/prathang/Prathang/Learnings/Assignment/deep_storage:/opt/druid/var/druid/segments
      - /Users/prathang/Prathang/Learnings/Assignment/logs:/opt/druid/var/druid/indexing-logs
    command:
      - middleManager
